<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Inventory Forecast Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
.navbar-brand { font-weight: bold; font-size: 1.5rem; }
.card { border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1rem; }
.kpi-card h4 { font-weight: bold; font-size: 1.8rem; margin: 0; }
.kpi-card.avg { background-color: #d1fae5; }  /* green */
.kpi-card.max { background-color: #bfdbfe; }  /* blue */
.kpi-card.min { background-color: #fee2e2; }  /* red */
.spinner { display: none; width: 30px; height: 30px; border: 4px solid #ddd; border-top: 4px solid #0d6efd; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
@keyframes spin { 100% { transform: rotate(360deg); } }
footer { background-color: #343a40; color: white; padding: 15px 0; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">AI Inventory Dashboard</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link active" href="/">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="/profile">Profile</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-4">

<h3 class="mb-4">Forecast Dashboard</h3>

<!-- Filters -->
<form id="forecastForm" class="row g-3 mb-4">
  <div class="col-md-3">
    <label class="form-label">Store</label>
    <select class="form-select" name="store_id" required>
      <option value="">Select Store</option>
      {% for s in stores %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">SKU</label>
    <select class="form-select" name="product_id" required>
      <option value="">Select SKU</option>
      {% for p in skus %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Start Date</label>
    <input type="date" class="form-control" name="start_date">
  </div>
  <div class="col-md-3">
    <label class="form-label">End Date</label>
    <input type="date" class="form-control" name="end_date">
  </div>
  <div class="col-12 mt-3 d-flex align-items-center">
    <button type="submit" class="btn btn-success me-2">Get Forecast</button>
    <button type="button" id="exportBtn" class="btn btn-secondary me-3">Export CSV</button>
    <div id="loadingSpinner" class="spinner"></div>
  </div>
</form>

<!-- Latest Forecast -->
<div class="card p-3">
  <h5>Latest Forecast</h5>
  <p id="latestForecast">Select store & SKU to view forecast</p>
</div>

<!-- KPI Cards -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card kpi-card avg text-center p-3">
      <h6>Average Forecast</h6>
      <h4 id="avgQty">-</h4>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card kpi-card max text-center p-3">
      <h6>Maximum Forecast</h6>
      <h4 id="maxQty">-</h4>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card kpi-card min text-center p-3">
      <h6>Minimum Forecast</h6>
      <h4 id="minQty">-</h4>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card p-3">
      <h5>Forecast Trend</h5>
      <canvas id="forecastChart"></canvas>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3">
      <h5>Top 10 SKUs</h5>
      <canvas id="topChart"></canvas>
    </div>
  </div>
</div>

<!-- Critical SKUs Table -->
<div class="card p-3">
  <h5>Critical SKUs (Stock Risk)</h5>
  <table class="table table-striped" id="criticalTable">
    <thead><tr><th>Product ID</th><th>Min Forecast Qty</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

</div>

<!-- Footer -->
<footer class="text-center">
  &copy; 2025 AI Inventory Dashboard | Developed by Your Name
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
const ctxTrend = document.getElementById('forecastChart').getContext('2d');
const ctxTop = document.getElementById('topChart').getContext('2d');
let trendChart, topChart;
const spinner = document.getElementById("loadingSpinner");

document.getElementById("forecastForm").onsubmit = async function(e){
    e.preventDefault();
    spinner.style.display = "inline-block";
    const formData = new FormData(this);
    const res = await fetch("/forecast",{method:"POST",body:formData});
    const data = await res.json();
    spinner.style.display = "none";

    if(data.error){
        document.getElementById("latestForecast").innerText = data.error;
        document.getElementById("avgQty").innerText = "-";
        document.getElementById("maxQty").innerText = "-";
        document.getElementById("minQty").innerText = "-";
        document.querySelector("#criticalTable tbody").innerHTML = "";
        if(trendChart) trendChart.destroy();
        if(topChart) topChart.destroy();
        return;
    }

    document.getElementById("latestForecast").innerText = 
        `Forecast: ${data.latest.forecast_qty} | Model: ${data.latest.model} | Date: ${data.latest.forecast_date}`;
    document.getElementById("avgQty").innerText = data.stats.avg;
    document.getElementById("maxQty").innerText = data.stats.max;
    document.getElementById("minQty").innerText = data.stats.min;

    const labelsTrend = data.history.map(r => r.date);
    const valuesTrend = data.history.map(r => r.qty);
    if(trendChart) trendChart.destroy();
    trendChart = new Chart(ctxTrend,{type:'line',data:{labels:labelsTrend,datasets:[{label:'Forecast Qty',data:valuesTrend,borderColor:'blue',backgroundColor:'rgba(0,0,255,0.1)',tension:0.3,fill:true}]} });

    const labelsTop = data.top_skus.map(r=>"SKU "+r.product_id);
    const valuesTop = data.top_skus.map(r=>r.total_forecast);
    if(topChart) topChart.destroy();
    topChart = new Chart(ctxTop,{type:'bar',data:{labels:labelsTop,datasets:[{label:'Total Forecast',data:valuesTop,backgroundColor:'rgba(54,162,235,0.7)'}]} });

    const tbody = document.querySelector("#criticalTable tbody");
    tbody.innerHTML = "";
    data.critical_skus.forEach(row => { 
        const tr = document.createElement("tr"); 
        tr.innerHTML = `<td>${row.product_id}</td><td>${row.min_qty}</td>`; 
        tbody.appendChild(tr); 
    });
};

document.getElementById("exportBtn").onclick = async function(){
    spinner.style.display = "inline-block";
    const formData = new FormData(document.getElementById("forecastForm"));
    const res = await fetch("/export",{method:"POST",body:formData});
    const blob = await res.blob();
    spinner.style.display = "none";

    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `forecast_export.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    alert("CSV Exported!");
};
</script>

</body>
</html>
